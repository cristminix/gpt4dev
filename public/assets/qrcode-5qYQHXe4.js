import"./modulepreload-polyfill-B5Qt9EMX.js";import p from"https://cdn.jsdelivr.net/npm/qr-scanner/qr-scanner.min.js";let m=window.location.hash.replace("#","");m||document.getElementById("generateQRCode").setAttribute("disabled","disabled");const y=document.getElementById("video"),E=document.getElementById("cam-status"),a=document.getElementById("qrcode-status");let i;localStorage.getItem("darkMode")!=="false"?document.body.classList.remove("white"):document.body.classList.add("white");document.getElementById("stopCamera").addEventListener("click",()=>{l&&l.getTracks().forEach(e=>e.stop()),i&&i.stop()});document.getElementById("toggleFlash").addEventListener("click",async()=>{i&&(await i.hasFlash()?i.toggleFlash():alert("Flash not supported on this device."))});let o=localStorage.getItem("backup"),c=null;if(o||m){const e=`${framework.backendUrl}/backend-api/v2/chat/${encodeURIComponent(o||m)}`,n=await fetch(e,{method:"GET"});if(n.status===200){const t=await n.json();t.backup&&(c=t.backup,o=t.id,document.getElementById("importBackup").removeAttribute("disabled"),console.log("Backup ready:",c))}}if(o){const e=`${window.location.origin}/chat/#${encodeURIComponent(o)}`;a.innerText=e,a.href=e,document.getElementById("qrcode").style.display="inline-block",new QRCode(document.getElementById("qrcode"),e,{width:400,height:400,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),document.getElementById("deleteQRCode").removeAttribute("disabled")}document.getElementById("deleteQRCode").addEventListener("click",async()=>{if(document.getElementById("deleteQRCode").setAttribute("disabled","disabled"),document.getElementById("qrcode-status").innerText="",o){localStorage.removeItem(`conversation:${o}`);const e=`${framework.backendUrl}/backend-api/v2/files/${encodeURIComponent(o)}`;await fetch(e,{method:"DELETE"}),document.getElementById("qrcode").innerHTML="",document.getElementById("qrcode").style.display="none",o=null}});function g(){if(!o)return;const e=`${window.location.origin}/qrcode.html#${encodeURIComponent(o)}`;a.innerText=e,a.href=e,document.getElementById("qrcode").innerHTML="",document.getElementById("qrcode").style.display="inline-block",new QRCode(document.getElementById("qrcode"),e,{width:400,height:400,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),document.getElementById("deleteBackup").removeAttribute("disabled")}document.getElementById("generateQRCode").addEventListener("click",async()=>{if(o){localStorage.removeItem(`conversation:${o}`);const s=`${framework.backendUrl}/backend-api/v2/files/${encodeURIComponent(o)}`;await fetch(s,{method:"DELETE"})}let e=JSON.parse(localStorage.getItem(`conversation:${m}`));e.share||(e.share=e.id,o=crypto.randomUUID(),e.id=o,e.updated=Date.now(),localStorage.setItem(`conversation:${o}`,JSON.stringify(e)));const n=`${framework.backendUrl}/backend-api/v2/chat/${encodeURIComponent(e.id)}`,t=await fetch(n,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(e)});if(t.status!==200){a.innerText="Error generating QR code: "+t.statusText;return}const d=`${window.location.origin}/chat/#${encodeURIComponent(e.id)}`;a.innerText=d,a.href=d,document.getElementById("qrcode").innerHTML="",document.getElementById("qrcode").style.display="inline-block",new QRCode(document.getElementById("qrcode"),d,{width:400,height:400,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),document.getElementById("deleteQRCode").removeAttribute("disabled")});const k=document.getElementById("switchCamera");let l=null,u="environment";async function h(){try{document.querySelectorAll(".scan-region-highlight").forEach(t=>t.remove()),l&&l.getTracks().forEach(t=>t.stop());const e={video:{width:{ideal:800},height:{ideal:800},facingMode:u},audio:!1},n=await navigator.mediaDevices.getUserMedia(e);l=n,video.srcObject=n,video.play(),i=new p(y,t=>{E.innerText="Camera Success: "+t.data,console.log("decoded QR code:",t),t.data.startsWith(window.location.origin)&&(window.parent.location=t.data)},{highlightScanRegion:!0,highlightCodeOutline:!0}),await i.start()}catch(e){console.error("Error accessing the camera:",e),alert(`Could not access the camera: ${e.message}`)}}k.addEventListener("click",()=>{u=u==="user"?"environment":"user",h()});document.getElementById("startCamera").addEventListener("click",()=>{h()});const r={};for(let e=0;e<localStorage.length;e++){let n=localStorage.key(e);if(n.startsWith("conversation:")){let t=localStorage.getItem(n);t=JSON.parse(t),delete t.items,delete t.data,delete t.system,r[n]=t}else n.startsWith("bucket:")&&(r[n]=localStorage.getItem(n))}console.log("Conversations loaded:",r);localStorage.getItem("backup")&&(document.getElementById("showBackup").removeAttribute("disabled"),document.getElementById("deleteBackup").removeAttribute("disabled"));document.getElementById("generateBackup").addEventListener("click",async()=>{o||(o=crypto.randomUUID(),localStorage.setItem("backup",o));const e=`${framework.backendUrl}/backend-api/v2/chat/${encodeURIComponent(o)}`,n=await fetch(e,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({id:o,updated:Date.now(),backup:r})}),t=document.getElementById("qrcode-status");if(n.status!==200){t.innerText="Error on backup: "+n.statusText;return}Object.keys(r).forEach(d=>{if(d.startsWith("conversation:")){let s=r.backup||d.replaceAll("conversation:","");console.log("Saving conversation:",s,r[d]);const f=`${framework.backendUrl}/backend-api/v2/chat/${encodeURIComponent(s)}`;fetch(f,{method:"POST",headers:{"content-type":"application/json"},body:localStorage.getItem(d)})}}),c=r,g()});document.getElementById("importBackup").addEventListener("click",async()=>{let e=0;c&&Object.keys(c).forEach(n=>{localStorage.getItem(n)||(localStorage.setItem(n,JSON.stringify(c[n])),e++)}),document.getElementById("importBackup").setAttribute("disabled","disabled"),a.innerText=`${e||0} conversations imported from backup.`});document.getElementById("deleteBackup").addEventListener("click",async()=>{if(c&&Object.keys(c).forEach(e=>{if(e.startsWith("conversation:")){let n=c[e].backup||e.replace("conversation:","");const t=`${framework.backendUrl}/backend-api/v2/files/${encodeURIComponent(n)}`;fetch(t,{method:"DELETE"})}}),o){localStorage.removeItem(`conversation:${o}`);const e=`${framework.backendUrl}/backend-api/v2/files/${encodeURIComponent(o)}`;await fetch(e,{method:"DELETE"})}localStorage.removeItem("backup"),document.getElementById("deleteBackup").setAttribute("disabled","disabled"),document.getElementById("importBackup").setAttribute("disabled","disabled"),document.getElementById("qrcode").innerHTML="",document.getElementById("qrcode").style.display="none",a.innerText=""});document.getElementById("showBackup").addEventListener("click",g);
